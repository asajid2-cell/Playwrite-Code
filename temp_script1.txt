
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.3/jquery-ui.min.js"></script>
    <script src="{{ url_for('static', filename='js/underscore-min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/raphael-min.js') }}"></script>
    <script src="{{ url_for('static', filename='jremix.js') }}"></script>
    <script src="{{ url_for('static', filename='js/visualizer.js') }}"></script>
    <script>
    (function() {
        const body = document.body;
        const vizPanelElement = document.getElementById('viz-panel');
        const algorithmToggle = document.getElementById('algorithm-toggle');
        const sourceToggle = document.getElementById('source-toggle');
        const algorithmInput = document.getElementById('algorithm-input');
        const sourceInput = document.getElementById('source-input');
        const uploadPane = document.getElementById('upload-pane');
        const youtubePane = document.getElementById('youtube-pane');
        const form = document.getElementById('process-form');
        const statusPanel = document.getElementById('form-status');
        const modeFromBody = (body.dataset.mode || "canon").toLowerCase();
        let currentModeKey = modeFromBody;

        const setState = (state) => {
            body.classList.remove('state-home', 'state-player');
            body.classList.add(state);
            if (state === 'state-home' && vizPanelElement) {
                vizPanelElement.style.left = '';
                vizPanelElement.style.top = '';
                vizPanelElement.style.width = '';
                vizPanelElement.style.height = '';
            }
        };

        const backButton = document.getElementById('back-button');

        if ({{ 'true' if track_id else 'false' }}) {
            setState('state-player');
            if (backButton) {
                backButton.classList.remove('hidden');
                backButton.setAttribute('href', window.location.pathname + window.location.search.replace(/([?&])trid=[^&]*/g, '').replace(/^&/, '?'));
            }
        } else {
            if (backButton) { backButton.classList.add('hidden'); }
            setState('state-home');
        }

        function syncAlgorithmButtons(targetMode) {
            algorithmToggle.querySelectorAll('.toggle').forEach(btn => btn.classList.remove('active'));
            const match = algorithmToggle.querySelector('[data-algorithm=\"' + targetMode + '\"]');
            if (match) {
                match.classList.add('active');
                algorithmInput.value = targetMode;
            }
        }

        if (modeFromBody === "jukebox" || modeFromBody === "eternal" || modeFromBody === "canon") {
            syncAlgorithmButtons(modeFromBody);
        }

        algorithmToggle.addEventListener('click', (event) => {
            const button = event.target.closest('button[data-algorithm]');
            if (!button) {
                return;
            }
            const targetMode = button.dataset.algorithm;
            syncAlgorithmButtons(targetMode);
            currentModeKey = (targetMode || '').toLowerCase();
            body.dataset.mode = targetMode;
            window.setAdvancedPanelMode(currentModeKey);
        });

        sourceToggle.addEventListener('click', (event) => {
            const button = event.target.closest('button[data-source]');
            if (!button) {
                return;
            }
            sourceToggle.querySelectorAll('.toggle').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            const source = button.dataset.source;
            sourceInput.value = source;
            if (source === 'upload') {
                uploadPane.classList.remove('hidden');
                youtubePane.classList.add('hidden');
            } else {
                youtubePane.classList.remove('hidden');
                uploadPane.classList.add('hidden');
            }
        });

        form.addEventListener('submit', async (event) => {
