
        const MODE_PRIMARY_GROUPS = {
            canon: ['canonOverlay'],
            jukebox: ['jukeboxLoop'],
            eternal: ['eternalOverlay', 'eternalLoop']
        };

        function buildAdvancedUi() {
            if (!advancedSidebar || !advancedShell || !advancedSectionsRoot) {
                return;
            }
            if (typeof window.getAdvancedSettings !== 'function' || typeof window.updateAdvancedGroupSetting !== 'function') {
                return;
            }

            advancedSectionsRoot.innerHTML = '';
            Object.keys(advancedDomMap).forEach((key) => { delete advancedDomMap[key]; });
            Object.keys(advancedSectionNodes).forEach((key) => { delete advancedSectionNodes[key]; });

            ADVANCED_SECTION_LAYOUT.forEach((sectionConfig) => {
                const sectionNode = document.createElement('section');
                sectionNode.className = 'advanced-section';
                sectionNode.dataset.sectionMode = sectionConfig.id;

                const sectionHeader = document.createElement('header');
                sectionHeader.className = 'advanced-section-header';

                const headerTitle = document.createElement('h4');
                headerTitle.textContent = sectionConfig.label;
                sectionHeader.appendChild(headerTitle);

                if (sectionConfig.summary) {
                    const summaryNode = document.createElement('p');
                    summaryNode.className = 'advanced-section-summary';
                    summaryNode.textContent = sectionConfig.summary;
                    sectionHeader.appendChild(summaryNode);
                }

                sectionNode.appendChild(sectionHeader);

                sectionConfig.groups.forEach((groupKey) => {
                    const meta = ADVANCED_GROUP_METADATA[groupKey];
                    if (!meta) {
                        return;
                    }

                    const groupNode = document.createElement('article');
                    groupNode.className = 'advanced-group';
                    groupNode.dataset.groupKey = groupKey;

                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'advanced-group-header';

                    const titleNode = document.createElement('h5');
                    titleNode.className = 'advanced-group-title';
                    titleNode.textContent = meta.title;
                    groupHeader.appendChild(titleNode);

                    const collapseButton = document.createElement('button');
                    collapseButton.type = 'button';
                    collapseButton.className = 'advanced-collapse-btn';
                    collapseButton.setAttribute('aria-label', `Toggle ${meta.title} settings`);
                    collapseButton.setAttribute('aria-expanded', 'false');
                    collapseButton.innerHTML = '<span class="chevron"></span>';

                    const toggleLabel = document.createElement('label');
                    toggleLabel.className = 'advanced-group-toggle';

                    const toggle = document.createElement('input');
                    toggle.type = 'checkbox';
                    toggle.dataset.groupKey = groupKey;
                    toggle.id = `advanced-toggle-${groupKey}`;
                    toggleLabel.appendChild(toggle);

                    const toggleText = document.createElement('span');
                    toggleText.textContent = 'Enable custom settings';
                    toggleLabel.appendChild(toggleText);

                    groupHeader.appendChild(toggleLabel);
                    groupHeader.appendChild(collapseButton);
                    groupNode.appendChild(groupHeader);

                    const bodyWrapper = document.createElement('div');
                    bodyWrapper.className = 'advanced-group-body';
                    groupNode.appendChild(bodyWrapper);

                    if (meta.description) {
                        const descriptionNode = document.createElement('p');
                        descriptionNode.className = 'advanced-group-description';
                        descriptionNode.textContent = meta.description;
                        bodyWrapper.appendChild(descriptionNode);
                    }

                    const fieldsContainer = document.createElement('div');
                    fieldsContainer.className = 'advanced-fields';
                    bodyWrapper.appendChild(fieldsContainer);

                    const inputs = Object.create(null);
                    const valueLabels = Object.create(null);
                    const fieldMeta = Object.create(null);

                    meta.fields.forEach((field) => {
                        const control = document.createElement('div');
                        control.className = 'advanced-control';

                        const topLine = document.createElement('div');
                        topLine.className = 'advanced-control-topline';

                        const labelNode = document.createElement('label');
                        labelNode.className = 'advanced-control-label';
                        labelNode.htmlFor = `advanced-${groupKey}-${field.key}`;
                        labelNode.textContent = field.label;
                        topLine.appendChild(labelNode);

                        const valueNode = document.createElement('span');
                        valueNode.className = 'advanced-control-value';
                        topLine.appendChild(valueNode);

                        control.appendChild(topLine);

                        const input = document.createElement('input');
                        input.type = 'range';
                        input.min = field.min;
                        input.max = field.max;
                        if (field.step !== undefined) {
                            input.step = field.step;
                        } else if (field.max - field.min <= 1) {
                            input.step = 0.01;
                        }
                        input.id = `advanced-${groupKey}-${field.key}`;
                        input.dataset.groupKey = groupKey;
                        input.dataset.fieldKey = field.key;

                        control.appendChild(input);

                        if (field.description) {
                            const hint = document.createElement('p');
                            hint.className = 'advanced-control-hint';
                            hint.textContent = field.description;
                            control.appendChild(hint);
                        }

                        fieldsContainer.appendChild(control);

                        inputs[field.key] = input;
                        valueLabels[field.key] = valueNode;
                        fieldMeta[field.key] = field;

                        input.addEventListener('input', handleAdvancedFieldInput);
                        input.addEventListener('change', handleAdvancedFieldCommit);
                    });

                    const resetButton = document.createElement('button');
                    resetButton.type = 'button';
                    resetButton.className = 'viz-button ghost advanced-reset-button';
                    resetButton.dataset.groupKey = groupKey;
                    resetButton.textContent = 'Reset to defaults';
                    resetButton.addEventListener('click', handleAdvancedReset);
                    bodyWrapper.appendChild(resetButton);

                    toggle.addEventListener('change', handleAdvancedToggle);

                    advancedDomMap[groupKey] = {
                        groupNode,
                        toggle,
                        body: bodyWrapper,
                        collapseButton,
                        inputs,
                        valueLabels,
                        fieldMeta,
                        resetButton,
                        fieldsContainer
                    };

                    collapseButton.addEventListener('click', () => {
                        const dom = advancedDomMap[groupKey];
                        if (!dom) {
                            return;
                        }
                        const collapsed = dom.groupNode.classList.contains('is-collapsed');
                        setGroupCollapsed(groupKey, !collapsed);
                    });

                    sectionNode.appendChild(groupNode);
                    setGroupCollapsed(groupKey, true);
                });

                advancedSectionsRoot.appendChild(sectionNode);
                advancedSectionNodes[sectionConfig.id] = sectionNode;
            });

            Object.keys(ADVANCED_GROUP_METADATA).forEach((groupKey) => {
                syncGroupFromState(groupKey);
            });

            advancedUiReady = true;
            window.setAdvancedPanelMode(pendingAdvancedMode);
        }

        function ensureAdvancedUi() {
            if (advancedUiReady) {
                return;
            }
            buildAdvancedUi();
        }

        function disableAllAdvancedGroups() {
            if (!advancedUiReady) {
                return;
            }
            Object.keys(ADVANCED_GROUP_METADATA).forEach((groupKey) => {
                if (isGroupEnabled(groupKey)) {
                    setGroupEnabled(groupKey, false);
                }
                setGroupInputsDisabled(groupKey, true);
                setGroupCollapsed(groupKey, true);
                const dom = advancedDomMap[groupKey];
                if (dom && dom.toggle) {
                    dom.toggle.checked = false;
                }
            });
        }

        function setAdvancedVisibility(enabled) {
            const normalized = !!enabled;
            if (normalized === advancedSidebarVisible) {
                updateAdvancedToggleState();
                return;
            }
            advancedSidebarVisible = normalized;
            body.classList.toggle('advanced-expanded', normalized);
            body.classList.toggle('advanced-collapsed', !normalized);
            updateAdvancedToggleState();
            if (normalized) {
                ensureAdvancedUi();
                ensureModeDefaults(currentModeKey);
                showAdvancedSidebar();
                window.setAdvancedPanelMode(currentModeKey);
            } else if (advancedSidebar) {
                disableAllAdvancedGroups();
                advancedSidebar.classList.add('hidden');
                advancedSidebar.setAttribute('aria-hidden', 'true');
            }
        }

        function handleAdvancedToggle(event) {
            const checkbox = event.currentTarget;
            const groupKey = checkbox && checkbox.dataset ? checkbox.dataset.groupKey : null;
            if (!groupKey) {
                return;
            }
            const enabled = checkbox.checked;
            setGroupEnabled(groupKey, enabled);
            setGroupInputsDisabled(groupKey, !enabled);
            syncGroupFromState(groupKey);
            if (enabled) {
                setGroupCollapsed(groupKey, false);
                forceAdvancedApply(groupKey, null, null, 'toggle');
            } else {
                setGroupCollapsed(groupKey, true);
            }
        }

        function forceAdvancedApply(groupKey, fieldKey, value, sourceTag) {
            const source = sourceTag || 'ui';
            if (typeof window.setAdvancedGroupEnabled === 'function') {
                window.setAdvancedGroupEnabled(groupKey, true);
            }
            if (typeof window.updateAdvancedGroupSetting === 'function' && fieldKey !== null && fieldKey !== undefined && value !== null && !Number.isNaN(value)) {
                window.updateAdvancedGroupSetting(groupKey, fieldKey, value);
            }
            if (typeof window.applyImmediateAdvancedSetting === 'function' && fieldKey !== null && fieldKey !== undefined && value !== null && !Number.isNaN(value)) {
                window.applyImmediateAdvancedSetting(groupKey, fieldKey, value);
            }
            if (typeof window.applyAdvancedGroup === 'function') {
                window.applyAdvancedGroup(groupKey, { source });
            } else if (groupKey === 'canonOverlay' && typeof window.regenerateCanonMappingManually === 'function') {
                window.regenerateCanonMappingManually();
            } else if (groupKey === 'eternalOverlay' && typeof window.regenerateEternalOverlay === 'function') {
                window.regenerateEternalOverlay({ source });
            } else {
                syncGroupFromState(groupKey);
            }
        }

        function handleAdvancedFieldInput(event) {
            const input = event.currentTarget;
            const groupKey = input && input.dataset ? input.dataset.groupKey : null;
            const fieldKey = input && input.dataset ? input.dataset.fieldKey : null;
            if (!groupKey || !fieldKey) {
                return;
            }
            const value = parseFloat(input.value);
            if (Number.isNaN(value)) {
                return;
            }
            updateValueLabel(groupKey, fieldKey, value);
            enforceGroupConstraints(groupKey);
            if (groupKey === 'canonOverlay') {
                if (typeof window.setCanonAdvancedEnabled === 'function') {
