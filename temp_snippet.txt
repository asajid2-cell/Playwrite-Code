        });

        const advancedToggleButton = document.getElementById('advanced-toggle');
        const advancedSidebar = document.getElementById('advanced-sidebar');
        const advancedShell = document.getElementById('advanced-shell');
        const advancedSectionsRoot = document.getElementById('advanced-sections');

        body.classList.add('advanced-collapsed');

        let advancedSidebarVisible = false;

        function updateAdvancedToggleState() {
            if (!advancedToggleButton) {
                return;
            }
            advancedToggleButton.setAttribute('aria-pressed', advancedSidebarVisible ? 'true' : 'false');
            advancedToggleButton.classList.toggle('active', advancedSidebarVisible);
            advancedToggleButton.textContent = advancedSidebarVisible ? 'Advanced: On' : 'Advanced: Off';
        }

        if (advancedSidebar) {
            advancedSidebar.classList.add('hidden');
            advancedSidebar.setAttribute('aria-hidden', 'true');
        }

        function showAdvancedSidebar() {
            if (!advancedSidebarVisible || !advancedSidebar) {
                return;
            }
            advancedSidebar.classList.remove('hidden');
            advancedSidebar.removeAttribute('aria-hidden');
        }

        function syncAdvancedUiForMode(modeKey) {
            if (!advancedSidebarVisible) {
                return;
            }
            const normalized = (modeKey || currentModeKey || 'canon').toLowerCase();
            currentModeKey = normalized;
            primeGroupLayoutForMode(currentModeKey);
            showAdvancedSidebar();
        }

        window.setCanonUiVisibility = (visible) => {
            if (visible && advancedSidebarVisible) {
                window.setAdvancedPanelMode('canon');
            }
        };

        window.setAdvancedPanelMode = (modeKey) => {
            const normalized = (modeKey || currentModeKey || 'canon').toLowerCase();
            currentModeKey = normalized;
            pendingAdvancedMode = normalized;
            if (!advancedSidebarVisible) {
                return;
            }
            ensureAdvancedUi();
            ensureModeDefaults(currentModeKey);
            syncAdvancedSectionsForMode(currentModeKey);
            syncAdvancedUiForMode(currentModeKey);
        };

        const ADVANCED_GROUP_METADATA = {
            canonOverlay: {
                title: 'Overlay Behaviour',
                description: 'Set spacing, dwell, and texture for the live Autocanonizer voices.',
                fields: [
                    { key: 'minOffsetBeats', label: 'Minimum Offset', min: 1, max: 96, step: 1, format: (v) => `${v} beats`, description: 'Earliest beat separation between overlay voices.' },
                    { key: 'maxOffsetBeats', label: 'Maximum Offset', min: 2, max: 128, step: 1, format: (v) => `${v} beats`, description: 'Largest allowed beat offset between overlay voices.' },
                    { key: 'dwellBeats', label: 'Dwell', min: 1, max: 16, step: 1, format: (v) => `${v} beats`, description: 'Minimum beats to stay on a pairing before retargeting.' },
                    { key: 'density', label: 'Density', min: 1, max: 6, step: 1, format: (v) => `${v}/6`, description: 'Higher values add more simultaneous overlay voices.' },
                    { key: 'variation', label: 'Variation', min: 0, max: 10, step: 1, format: (v) => `${v}`, description: 'Controls how adventurous the overlay can be when rewiring connections.' }
                ]
            },
            jukeboxLoop: {
                title: 'Loop Pathing',
                description: 'Dial in how Eternal Jukebox picks loops and when it moves on.',
                fields: [
                    { key: 'minLoopBeats', label: 'Minimum Loop Length', min: 4, max: 64, step: 1, format: (v) => `${v} beats`, description: 'Shortest loop allowed when picking jump targets.' },
                    { key: 'maxSequentialBeats', label: 'Sequential Ceiling', min: 8, max: 128, step: 1, format: (v) => `${v} beats`, description: 'Maximum beats to play before forcing a jump.' },
                    { key: 'loopThreshold', label: 'Similarity Threshold', min: 0.3, max: 0.95, step: 0.01, format: (v) => `${Math.round(v * 100)}%`, description: 'Higher values require closer similarity before a loop is accepted.' },
                    { key: 'sectionBias', label: 'Section Bias', min: 0, max: 1, step: 0.05, format: (v) => `${Math.round(v * 100)}% in-section`, description: 'Preference for staying within the same section when looping.' },
                    { key: 'jumpVariance', label: 'Jump Variance', min: 0, max: 1, step: 0.05, format: (v) => `${Math.round(v * 100)}%`, description: 'Higher values encourage varied jump timing; lower values keep loops tighter.' }
                ]
            },
            eternalOverlay: {
                title: 'Overlay Behaviour',
                description: 'Shape the multivoice overlay used in Eternal Canonizer mode.',
                fields: [
                    { key: 'minOffsetBeats', label: 'Minimum Offset', min: 1, max: 96, step: 1, format: (v) => `${v} beats`, description: 'Earliest beat separation for overlay voices.' },
                    { key: 'maxOffsetBeats', label: 'Maximum Offset', min: 2, max: 128, step: 1, format: (v) => `${v} beats`, description: 'Largest beat separation for overlay voices.' },
                    { key: 'dwellBeats', label: 'Dwell', min: 1, max: 16, step: 1, format: (v) => `${v} beats`, description: 'Minimum beats before switching overlay targets.' },
                    { key: 'density', label: 'Density', min: 1, max: 6, step: 1, format: (v) => `${v}/6`, description: 'Higher values add thicker overlays.' },
                    { key: 'variation', label: 'Variation', min: 0, max: 10, step: 1, format: (v) => `${v}`, description: 'Controls how much the overlay may deviate from its base pattern.' }
                ]
            },
            eternalLoop: {
                title: 'Loop Pathing',
                description: 'Control loop behaviour when running the Eternal Canonizer.',
                fields: [
