<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Harmonizer Lab</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='modern.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='visualizer.css') }}">
</head>
<body class="page {% if track_id %}state-player{% else %}state-home{% endif %}" data-mode="{{ mode }}">
    <div class="music-field" aria-hidden="true">
        <div class="music track one"><span></span><span></span><span></span><span></span><span></span></div>
        <div class="music track two"><span></span><span></span><span></span><span></span><span></span></div>
        <div class="music track three"><span></span><span></span><span></span><span></span><span></span></div>
    </div>

    <div class="page-shell">
        <header class="hero">
            <div class="hero-meta">
                <div class="badge">Harmonizer Lab</div>
                <h1>Autocanonizer</h1>
                <p>Analyze a track and perform it as a canon—clean visuals, smooth overlays, zero fuss.</p>
            </div>
        </header>

        <main class="layout">
            <section class="panel intake-panel" id="intake-panel">
                <h2>Load A Track</h2>
                <form id="process-form" enctype="multipart/form-data" novalidate>
                    <div class="section-title">Engine</div>
                    <div class="toggle-group" id="algorithm-toggle">
                        <button type="button" data-algorithm="canon" class="toggle active">Autocanonizer</button>
                        <button type="button" data-algorithm="jukebox" class="toggle">Eternal Jukebox</button>
                        <button type="button" data-algorithm="eternal" class="toggle">Eternal Canonizer</button>
                    </div>
                    <input type="hidden" name="algorithm" value="canon" id="algorithm-input">

                    <div class="section-title">Source</div>
                    <div class="toggle-group" id="source-toggle">
                        <button type="button" data-source="upload" class="toggle active">Upload Audio</button>
                        <button type="button" data-source="youtube" class="toggle">YouTube</button>
                    </div>
                    <input type="hidden" name="source" value="upload" id="source-input">

                    <div class="source-pane" id="upload-pane">
                        <label class="field">
                            <span>Audio file</span>
                            <input type="file" name="audio" accept="audio/*">
                        </label>
                    </div>

                    <div class="source-pane hidden" id="youtube-pane">
                        <label class="field">
                            <span>YouTube link</span>
                            <input type="url" name="youtube_url" placeholder="https://www.youtube.com/watch?v=...">
                        </label>
                    </div>

                    <div class="metadata-grid">
                        <label class="field">
                            <span>Title <small>(optional)</small></span>
                            <input type="text" name="title" placeholder="Auto-detected when possible">
                        </label>
                        <label class="field">
                            <span>Artist <small>(optional)</small></span>
                            <input type="text" name="artist" placeholder="Auto-detected when possible">
                        </label>
                    </div>

                    <button type="submit" class="cta">Transform Track</button>
                </form>
                <div id="form-status" class="status-panel" role="status" aria-live="polite"></div>
                <div class="tips">
                    <p>YouTube imports require <code>ffmpeg</code> in PATH.</p>
                    <p class="meta">CLI: <code>python analysis/analyze_track.py --help</code></p>
                </div>
            </section>

            <section class="panel viz-panel music-frame" id="viz-panel">
                <header class="viz-header">
                    <div class="viz-headline">
                        <h2>Visualizer</h2>
                        <p id="info"></p>
                    </div>
                    <div class="viz-actions">
                        <button id="play" class="viz-button">Play</button>
                        <span class="viz-timer" id="mtime">00:00:00</span>
                        <span class="viz-mode-pill" id="mode-pill">
                            {% if mode == 'jukebox' %}
                                Eternal Jukebox
                            {% elif mode == 'eternal' %}
                                Eternal Canonizer
                            {% else %}
                                Autocanonizer
                            {% endif %}
                        </span>
                    </div>
                </header>
                <div class="viz-status" id="status-panel"></div>
                <div id="error"></div>
                <div id="tiles" class="tiles-canvas"></div>
                <footer class="viz-footer">
                    Press space to toggle playback &middot; Drag the window wider for more detail
                </footer>
            </section>
        </main>

        <footer class="footer">
            Crafted for modern remixes &middot; palette: obsidian / carmine / rose quartz
        </footer>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.3/jquery-ui.min.js"></script>
    <script src="{{ url_for('static', filename='js/underscore-min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/raphael-min.js') }}"></script>
    <script src="{{ url_for('static', filename='jremix.js') }}"></script>
    <script src="{{ url_for('static', filename='js/visualizer.js') }}"></script>
    <script>
    (function() {
        const body = document.body;
        const algorithmToggle = document.getElementById('algorithm-toggle');
        const sourceToggle = document.getElementById('source-toggle');
        const algorithmInput = document.getElementById('algorithm-input');
        const sourceInput = document.getElementById('source-input');
        const uploadPane = document.getElementById('upload-pane');
        const youtubePane = document.getElementById('youtube-pane');
        const form = document.getElementById('process-form');
        const statusPanel = document.getElementById('form-status');
        const modeFromBody = body.dataset.mode || "canon";

        const setState = (state) => {
            body.classList.remove('state-home', 'state-player');
            body.classList.add(state);
        };

        if ({{ 'true' if track_id else 'false' }}) {
            setState('state-player');
        } else {
            setState('state-home');
        }

        function syncAlgorithmButtons(targetMode) {
            algorithmToggle.querySelectorAll('.toggle').forEach(btn => btn.classList.remove('active'));
            const match = algorithmToggle.querySelector('[data-algorithm=\"' + targetMode + '\"]');
            if (match) {
                match.classList.add('active');
                algorithmInput.value = targetMode;
            }
        }

        if (modeFromBody === "jukebox" || modeFromBody === "eternal" || modeFromBody === "canon") {
            syncAlgorithmButtons(modeFromBody);
        }

        algorithmToggle.addEventListener('click', (event) => {
            const button = event.target.closest('button[data-algorithm]');
            if (!button) {
                return;
            }
            syncAlgorithmButtons(button.dataset.algorithm);
        });

        sourceToggle.addEventListener('click', (event) => {
            const button = event.target.closest('button[data-source]');
            if (!button) {
                return;
            }
            sourceToggle.querySelectorAll('.toggle').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            const source = button.dataset.source;
            sourceInput.value = source;
            if (source === 'upload') {
                uploadPane.classList.remove('hidden');
                youtubePane.classList.add('hidden');
            } else {
                youtubePane.classList.remove('hidden');
                uploadPane.classList.add('hidden');
            }
        });

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            statusPanel.textContent = '';
            const source = sourceInput.value;
            if (source === 'upload') {
                const fileInput = form.querySelector('input[name="audio"]');
                if (!fileInput.files || fileInput.files.length === 0) {
                    statusPanel.textContent = 'Please choose an audio file to upload.';
                    return;
                }
            } else {
                const urlField = form.querySelector('input[name="youtube_url"]');
                if (!urlField.value) {
                    statusPanel.textContent = 'Please paste a YouTube link.';
                    return;
                }
            }

            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Processing…';
            statusPanel.textContent = 'Analyzing audio – this can take a minute.';

            try {
                const formData = new FormData(form);
                const response = await fetch('/api/process', {
                    method: 'POST',
                    body: formData
                });
                const payload = await response.json();
                if (!response.ok) {
                    throw new Error(payload.error || 'Something went wrong.');
                }
                statusPanel.textContent = 'Ready! Loading the visualizer…';
                window.location.href = payload.redirect;
            } catch (err) {
                statusPanel.textContent = err.message;
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Transform Track';
            }
        });
        // helper to clear params when browser back/forward is used
        window.addEventListener('popstate', () => {
            const params = new URLSearchParams(window.location.search);
            if (!params.has('trid')) {
                setState('state-home');
                if (driver && typeof driver.stop === "function") {
                    driver.stop();
                }
            }
        });
    })();
    </script>
</body>
</html>

